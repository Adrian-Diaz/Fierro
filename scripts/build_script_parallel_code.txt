#!/usr/bin/env bash

#update submodules
git submodule update --init --recursive

#check if Trilinos directory exists, git clone Trilinos if it doesn't
[ -d "Trilinos" ] && echo "Directory Trilinos exists, skipping Trilinos download"

if [ ! -d "Trilinos" ]
then
  echo "Directory Trilinos does not exist, downloading Trilinos...."
  git clone https://github.com/trilinos/Trilinos.git
fi

#check if Trilinos build directory exists, create Trilinos/build if it doesn't
[ -d "Trilinos/build" ] && echo "Directory Trilinos/build exists, moving on"

if [ ! -d "Trilinos/build" ]
then
  echo "Directory Trilinos/build does not exist, creating it...."
  mkdir Trilinos/build
fi

#check if Trilinos library files were installed, install them otherwise.
[ -d "Trilinos/build/lib" ] && echo "Directory Trilinos/build/lib exists, assuming successful installation; delete build folder and run build script again if there was an environment error that has been corrected."

if [ ! -d "Trilinos/build/lib" ]
then
  echo "Directory Trilinos/build/lib does not exist, compiling Trilinos (this might take a while)...."
  #make text files for scripts executable
  chmod +x Trilinos_Build_Scripts/cmake_configure_muelu.txt
  cd Trilinos/build
  ./../../Trilinos_Build_Scripts/cmake_configure_muelu.txt
  make -j"&1" install all
  cd ../..
fi

#build Fierro, start by initializing submodules
cmake -DBUILD_PARALLEL_EXPLICIT_SOLVER=ON .
make -j"&1"
